<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×¨×™×•×§×™ ×—×‘×¨×ª×™ - ×¢× ×©××•×ª</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 10px; }
        
        /* ××–×•×¨ ×”× ×’×Ÿ - ×¨×§ ×œ××—×©×‘ */
        #host-area { display: none; background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .skip-btn { background: #ffc107; color: black; font-weight: bold; width: 100%; padding: 15px; border: none; font-size: 18px; cursor: pointer; margin-top: 10px; border-radius: 5px; }
        #now-playing-text { color: #ff0055; font-size: 1.5em; display: block; margin: 10px 0; }

        /* ×›×¤×ª×•×¨ ×”×¤×¢×œ×” ×¨××©×•× ×™ */
        .setup-btn { background: #007bff; color: white; padding: 20px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 20px; }

        /* ××–×•×¨ ×”×•×¡×¤×ª ×©×™×¨×™× */
        .input-group { margin-bottom: 15px; }
        input { padding: 12px; width: 90%; font-size: 16px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        .search-btn { padding: 12px; background: #ff0055; color: white; border: none; font-size: 18px; width: 95%; border-radius: 5px; cursor: pointer; }

        /* ×¨×©×™××ª ×”×©×™×¨×™× */
        ul { list-style: none; padding: 0; max-width: 600px; margin: 20px auto; }
        li { background: #2a2a2a; margin: 8px 0; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; border-right: 4px solid #ff0055; }
        
        .song-details { text-align: right; }
        .singer-name { color: #ff0055; font-weight: bold; font-size: 0.9em; display: block; }
        .song-title { font-size: 1.1em; }

        .delete-btn { background: transparent; color: #aaa; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 50%; font-size: 14px; }
        .add-btn { background: #28a745; color: white; border: none; padding: 8px 20px; cursor: pointer; border-radius: 5px; margin-top: 5px; }
        
        /* ×ª×•×¦××•×ª ×—×™×¤×•×© */
        .result-item { background: #1e1e1e; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; flex-direction: column; align-items: center; }
    </style>
</head>
<body>

    <button id="setup-btn" class="setup-btn" onclick="activateHost()">ğŸ“º ×œ×—×¥ ×›××Ÿ ×× ×–×” ×”××—×©×‘ ×‘×˜×œ×•×•×™×–×™×”</button>

    <div id="host-area">
        <div id="player"></div> <div>××ª× ×’×Ÿ ×›×¢×ª: <span id="now-playing-text">...</span></div>
        <button class="skip-btn" onclick="playNext()">â­ ×“×œ×’ ×œ×©×™×¨ ×”×‘× / ×”×ª×—×œ ×œ× ×’×Ÿ</button>
    </div>

    <div style="background: #1e1e1e; padding: 15px; border-radius: 10px; max-width: 600px; margin: 0 auto;">
        <h3 style="margin-top: 0;">×”×•×¡×¤×ª ×©×™×¨</h3>
        
        <input type="text" id="userName" placeholder="××™ ×©×¨? (×œ××©×œ: ×“× ×™)" onchange="saveName()">
        
        <input type="text" id="searchIn" placeholder="××™×–×” ×©×™×¨ ×œ×—×¤×©?">
        
        <button class="search-btn" onclick="doSearch()">×—×¤×© ×©×™×¨ ğŸ”</button>
    </div>

    <div id="results"></div>

    <h3 style="margin-top: 30px;">×¨×©×™××ª ×”××ª× ×”:</h3>
    <ul id="queue"></ul>

  <script>
        // ==========================================
        // 1. ×”×’×“×¨×•×ª - ×•×•×“× ×©×”××¤×ª×—×•×ª ×›××Ÿ × ×›×•× ×™×!
        // ==========================================
        const YOUTUBE_API_KEY = 'AIzaSyCID8UzGuJDQE3e_3tY_xvbxQftQzwSwEA'; // *** ×”×›× ×¡ ×›××Ÿ ××ª ××¤×ª×— ×”×™×•×˜×™×•×‘ ×©×œ×š ***
                
        const firebaseConfig = {
            // *** ×”×›× ×¡ ×›××Ÿ ××ª ×”-Config ×-Firebase ***
            apiKey: "AIzaSyB3wOy7kFxXOPA1a8zWZmtlakXe7oXOsv0",
            authDomain: "tt-karaoke.firebaseapp.com",
            databaseURL: "https://tt-karaoke-default-rtdb.firebaseio.com",
            projectId: "tt-karaoke",
            storageBucket: "tt-karaoke.firebasestorage.app",
            messagingSenderId: "194564552518",
            appId: "1:194564552518:web:19ad2151e5c5bc53c79747",
            measurementId: "G-SN8MNYFCH6"
        };


        // ××ª×—×•×œ Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const queueRef = db.ref('simpleQueue');

        let player;
        let isHost = false;
        let queueData = []; 

        // ×˜×¢×™× ×ª ×©× ××©×ª××© ××—×¨×•×Ÿ ××”×–×™×›×¨×•×Ÿ
        document.getElementById('userName').value = localStorage.getItem('karaokeName') || '';

        function saveName() {
            localStorage.setItem('karaokeName', document.getElementById('userName').value);
        }

        // ==========================================
        // 2. × ×™×”×•×œ ×ª×•×¨ ×‘×–××Ÿ ×××ª
        // ==========================================
        queueRef.on('value', (snapshot) => {
            const listEl = document.getElementById('queue');
            listEl.innerHTML = '';
            queueData = []; 

            snapshot.forEach(child => {
                const song = { key: child.key, ...child.val() };
                queueData.push(song);

                const li = document.createElement('li');
                const singer = song.addedBy || "××•×¨×—";
                
                li.innerHTML = `
                    <div class="song-details">
                        <span class="singer-name">${singer} ×©×¨/×”:</span>
                        <span class="song-title">${song.title}</span>
                    </div>
                    <button class="delete-btn" onclick="removeSong('${song.key}')">X</button>
                `;
                listEl.appendChild(li);
            });
        });

        function removeSong(key) {
            if(confirm("×œ××—×•×§ ××ª ×”×©×™×¨?")) {
                queueRef.child(key).remove();
            }
        }

        // ==========================================
        // 3. ×—×™×¤×•×© ×•×”×•×¡×¤×”
        // ==========================================
        async function doSearch() {
            const q = document.getElementById('searchIn').value;
            const name = document.getElementById('userName').value;

            if (!q) { alert("×¦×¨×™×š ×œ×›×ª×•×‘ ×©× ×©×œ ×©×™×¨!"); return; }
            if (!name) { alert("×¦×¨×™×š ×œ×›×ª×•×‘ ××™ ×©×¨!"); return; }
            
            saveName(); 

            // ×”×ª×™×§×•×Ÿ: ×©×™××•×© ×‘××©×ª× ×” ×”× ×›×•×Ÿ YOUTUBE_API_KEY
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&q=${q} karaoke&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                const resDiv = document.getElementById('results');
                resDiv.innerHTML = '';
                
                if (data.items) {
                    data.items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `
                            <img src="${item.snippet.thumbnails.default.url}" style="width:120px; border-radius:5px;">
                            <span style="margin:5px 0;">${item.snippet.title}</span>
                            <button class="add-btn" onclick="add('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "")}')">×‘×—×¨ ××ª ×”×©×™×¨ ×”×–×”</button>
                        `;
                        resDiv.appendChild(div);
                    });
                } else if (data.error) {
                    console.error(data.error);
                    alert("×©×’×™××ª ×™×•×˜×™×•×‘: " + data.error.message);
                }
            } catch(e) {
                console.error(e);
                alert("×©×’×™××” ×‘×—×™×¤×•×©. ×•×•×“× ×©×”××¤×ª×—×•×ª ×©××•×¨×™× ×‘×§×•×‘×¥.");
            }
        }

        function add(id, title) {
            const name = document.getElementById('userName').value;
            queueRef.push({ 
                videoId: id, 
                title: title,
                addedBy: name 
            });
            document.getElementById('results').innerHTML = '<p style="color:green; font-size:18px;">âœ… ×”×©×™×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!</p>';
            document.getElementById('searchIn').value = '';
        }

        // ==========================================
        // 4. × ×’×Ÿ (Host)
        // ==========================================
        function activateHost() {
            isHost = true;
            document.getElementById('setup-btn').style.display = 'none';
            document.getElementById('host-area').style.display = 'block';

            if (!window.YT) { // ×‘×“×™×§×” ×œ×× ×™×¢×ª ×˜×¢×™× ×” ×›×¤×•×œ×”
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === 0) playNext(); 
        }

        function playNext() {
            if (queueData.length > 0) {
                const nextSong = queueData[0];
                const singer = nextSong.addedBy || "××•×¨×—";

                player.loadVideoById(nextSong.videoId);
                document.getElementById('now-playing-text').innerText = `${nextSong.title} (×©×¨: ${singer})`;
                
                queueRef.child(nextSong.key).remove();
            } else {
                alert("××™×Ÿ ×¢×•×“ ×©×™×¨×™× ×‘×ª×•×¨!");
            }
        }
    </script>
</body>
</html>
